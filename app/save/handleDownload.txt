  const handleDownload = async () => {
    try {
      const canvas = document.createElement('canvas');
      const size = 1024;
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      
      if (!ctx) {
        alert('Canvas를 생성할 수 없습니다.');
        return;
      }

      console.log('Starting download...');

      // Helper function
      const loadImage = (src: string): Promise<HTMLImageElement> => {
        return new Promise((resolve, reject) => {
          const img = new window.Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error(`Failed: ${src}`));
          img.src = src;
        });
      };

      // 원형 클리핑
      ctx.save();
      ctx.beginPath();
      ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
      ctx.clip();

      // 1. 배경
      if (selectedPattern) {
        try {
          const patternData = BACKGROUND_PATTERNS.find(p => p.id === selectedPattern);
          if (patternData?.image) {
            const patternImg = await loadImage(patternData.image);
            ctx.drawImage(patternImg, 0, 0, size, size);
          }
        } catch (error) {
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, size, size);
        }
      } else {
        ctx.fillStyle = selectedBackground;
        ctx.fillRect(0, 0, size, size);
      }

      // 2. 캐릭터 각 부분
      const scale = size / 400;
      const center = size / 2;
      const baseSize = 384 * scale;

      const layers = [];

      // Skin
      if (character.face.skinToneItemId) {
        layers.push({
          src: `/skin-tone-item-${character.face.skinToneItemId}.svg`,
          x: center - baseSize / 2,
          y: center - baseSize / 2,
          width: baseSize,
          height: baseSize
        });
      }

      // Eyes
      if (character.eyes.eyesItemId) {
        layers.push({
          src: `/eyes-item-${character.eyes.eyesItemId}.svg`,
          x: center - baseSize / 2,
          y: center - baseSize / 2,
          width: baseSize,
          height: baseSize
        });
      }

      // Nose
      if (character.nose.noseItemId) {
        const noseSize = baseSize * character.nose.size;
        const noseX = center - noseSize / 2 + (character.nose.position.x * scale);
        const noseY = center - noseSize / 2 + (character.nose.position.y * scale);
        layers.push({
          src: `/nose-item-${character.nose.noseItemId}.svg`,
          x: noseX,
          y: noseY,
          width: noseSize,
          height: noseSize
        });
      }

      // Mouth
      if (character.mouth.mouthItemId) {
        const mouthSize = baseSize * character.mouth.size;
        const mouthX = center - mouthSize / 2 + (character.mouth.position.x * scale);
        const mouthY = center - mouthSize / 2 + (character.mouth.position.y * scale);
        layers.push({
          src: `/mouth-item-${character.mouth.mouthItemId}.svg`,
          x: mouthX,
          y: mouthY,
          width: mouthSize,
          height: mouthSize
        });
      }

      // Hair
      if (character.hair.hairItemId) {
        layers.push({
          src: `/hair-item-${character.hair.hairItemId}.svg`,
          x: center - baseSize / 2,
          y: center - baseSize / 2,
          width: baseSize,
          height: baseSize
        });
      }

      // Features
      if (character.features?.featuresItemId) {
        layers.push({
          src: `/features-item-${character.features.featuresItemId}.svg`,
          x: center - baseSize / 2,
          y: center - baseSize / 2,
          width: baseSize,
          height: baseSize
        });
      }

      // Accessories
      if (character.accessories.headwear.itemId) {
        const y = center - baseSize / 2 + (character.accessories.headwear.position.y * scale);
        layers.push({
          src: `/headwear-item-${character.accessories.headwear.itemId}.svg`,
          x: center - baseSize / 2,
          y,
          width: baseSize,
          height: baseSize
        });
      }
      if (character.accessories.eyewear.itemId) {
        const y = center - baseSize / 2 + (character.accessories.eyewear.position.y * scale);
        layers.push({
          src: `/eyewear-item-${character.accessories.eyewear.itemId}.svg`,
          x: center - baseSize / 2,
          y,
          width: baseSize,
          height: baseSize
        });
      }
      if (character.accessories.piercings.itemId) {
        const y = center - baseSize / 2 + (character.accessories.piercings.position.y * scale);
        layers.push({
          src: `/piercings-item-${character.accessories.piercings.itemId}.svg`,
          x: center - baseSize / 2,
          y,
          width: baseSize,
          height: baseSize
        });
      }

      // 모든 레이어 그리기
      for (const layer of layers) {
        try {
          const img = await loadImage(layer.src);
          ctx.drawImage(img, layer.x, layer.y, layer.width, layer.height);
          console.log('Drew:', layer.src);
        } catch (error) {
          console.error('Failed:', layer.src);
        }
      }

      ctx.restore();

      // 3. 다운로드
      canvas.toBlob((blob) => {
        if (blob) {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          link.href = url;
          link.download = `REDROB_avatar_${timestamp}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          console.log('Downloaded!');
        }
      }, 'image/png');
    } catch (error) {
      console.error('Download failed:', error);
      alert(`다운로드 실패: ${error instanceof Error ? error.message : '알 수 없는 오류'}`);
    }
  };
